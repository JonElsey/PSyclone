MINI_APP ?= skeleton
MINI_APP_DIR=${HOME}/Projects/LFRic/NGMS-SoftwareStack/buildScripts/Linux/GCC10/trunk_r36316/miniapps/${MINI_APP}
API ?= -api 'dynamo0.3'

# Strip out '_tweaked' and any leading directory name to get the original
# name of the TL kernel.
KFILE=$(subst _tweaked,,${KERNEL_FILE})
KFILE_NO_DIR=$(KFILE:tangent_linear/%=%)
ADJ_OUTPUT=$(subst adjoint/,adjoint_partial/,${ADJ_FILE})

all:
	psyad ${API} ${KERNEL_FILE} -otest ${HARNESS_FILE} -oad ${ADJ_OUTPUT} ${GEOM_ARGS} -a ${ACTIVE_VARS}
	cp -f ${HARNESS_FILE} ${MINI_APP_DIR}/source/algorithm/adjoint_test_mod.x90
	cp -f ${KERNEL_FILE} ${MINI_APP_DIR}/source/kernel/${KFILE_NO_DIR}
	cp -f ${ADJ_FILE} ${MINI_APP_DIR}/source/kernel/.
	${MAKE} -j 6 -C ${MINI_APP_DIR} build
	cd ${MINI_APP_DIR}/example; ../bin/${MINI_APP} configuration.nml

clean:
	${MAKE} -C ${MINI_APP_DIR} clean
